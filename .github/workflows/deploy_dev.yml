name: Deploy FastAPI

on:
  push:
    branches: [ main, dev ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Write SSH deploy key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY_DEV }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo -e "Host ${{ vars.DEPLOY_HOST_DEV }}\n  HostName ${{ vars.DEPLOY_HOST_DEV }}\n  User ${{ vars.DEPLOY_USER_DEV || 'ubuntu' }}\n  IdentityFile ~/.ssh/deploy_key\n  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Login to Docker Hub (optional)
      if: env.DOCKERHUB_USERNAME
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build locally → send image → run on EC2 (no registry)
      env:
        DEPLOY_HOST: ${{ vars.DEPLOY_HOST_DEV }}
        DEPLOY_USER: ${{ vars.DEPLOY_USER_DEV || }}
      run: |
        # Build the image locally (with full cache, multi-platform if you want)
        docker buildx create --use
        docker buildx build --load --platform linux/amd64 -t myfastapi:latest .

        # Save the image to a tar file and stream it over SSH in one line
        docker save myfastapi:latest | gzip | ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} \
          "bunzip2 | docker load && \
           docker rm -f fastapi || true && \
           docker run -d --name fastapi --restart unless-stopped \
             -p 127.0.0.1:8000:8000 myfastapi:latest"
