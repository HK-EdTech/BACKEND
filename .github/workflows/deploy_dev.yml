name: Deploy FastAPI

on:
  push:
    branches: [ main, dev ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Write SSH deploy key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY_DEV }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo -e "Host ${{ vars.DEPLOY_HOST_DEV }}\n  HostName ${{ vars.DEPLOY_HOST_DEV }}\n  User ${{ vars.DEPLOY_USER_DEV || 'ubuntu' }}\n  IdentityFile ~/.ssh/deploy_key\n  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Login to Docker Hub (optional)
      if: env.DOCKERHUB_USERNAME
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Deploy to EC2 without Dcoker Hub registry using Docker context
      run: |
        docker context create remote --docker "host=ssh://${{ vars.DEPLOY_USER_DEV || 'ubuntu' }}@${{ vars.DEPLOY_HOST_DEV }}"
        docker --context remote build -t myfastapi .
        docker --context remote rm -f fastapi || true
        docker --context remote run -d --name fastapi --restart unless-stopped -p 127.0.0.1:8000:8000 myfastapi
